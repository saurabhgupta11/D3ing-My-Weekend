<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div id="container">
        <div id="my_dataviz"></div>
        <svg id="map" width="960" height="600"></svg>
    </div>
    <script>
        // set the dimensions and margins of the graph
        var margin = {top: 20, right: 30, bottom: 180, left: 30},
        width = 1600 - margin.left - margin.right,
        height = 370 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3.select("#my_dataviz")
        .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
        .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        // Read dummy data
        d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/data_network.json", function(notRequiredData) {
        
        const data = {
	"nodes": [{
		"id": "01",
		"name": "Alabama"
	}, {
		"id": "02",
		"name": "Alaska"
	}, {
		"id": "60",
		"name": "American Samoa"
	}, {
		"id": "04",
		"name": "Arizona"
	}, {
		"id": "05",
		"name": "Arkansas"
	}, {
		"id": "06",
		"name": "California"
	}, {
		"id": "08",
		"name": "Colorado"
	}, {
		"id": "69",
		"name": "Commonwealth of the Northern Mariana Islands"
	}, {
		"id": "09",
		"name": "Connecticut"
	}, {
		"id": "10",
		"name": "Delaware"
	}, {
		"id": "11",
		"name": "District of Columbia"
	}, {
		"id": "12",
		"name": "Florida"
	}, {
		"id": "13",
		"name": "Georgia"
	}, {
		"id": "66",
		"name": "Guam"
	}, {
		"id": "15",
		"name": "Hawaii"
	}, {
		"id": "16",
		"name": "Idaho"
	}, {
		"id": "17",
		"name": "Illinois"
	}, {
		"id": "18",
		"name": "Indiana"
	}, {
		"id": "19",
		"name": "Iowa"
	}, {
		"id": "20",
		"name": "Kansas"
	}, {
		"id": "21",
		"name": "Kentucky"
	}, {
		"id": "22",
		"name": "Louisiana"
	}, {
		"id": "23",
		"name": "Maine"
	}, {
		"id": "24",
		"name": "Maryland"
	}, {
		"id": "25",
		"name": "Massachusetts"
	}, {
		"id": "26",
		"name": "Michigan"
	}, {
		"id": "27",
		"name": "Minnesota"
	}, {
		"id": "28",
		"name": "Mississippi"
	}, {
		"id": "29",
		"name": "Missouri"
	}, {
		"id": "30",
		"name": "Montana"
	}, {
		"id": "31",
		"name": "Nebraska"
	}, {
		"id": "32",
		"name": "Nevada"
	}, {
		"id": "33",
		"name": "New Hampshire"
	}, {
		"id": "34",
		"name": "New Jersey"
	}, {
		"id": "35",
		"name": "New Mexico"
	}, {
		"id": "36",
		"name": "New York"
	}, {
		"id": "37",
		"name": "North Carolina"
	}, {
		"id": "38",
		"name": "North Dakota"
	}, {
		"id": "39",
		"name": "Ohio"
	}, {
		"id": "40",
		"name": "Oklahoma"
	}, {
		"id": "41",
		"name": "Oregon"
	}, {
		"id": "42",
		"name": "Pennsylvania"
	}, {
		"id": "72",
		"name": "Puerto Rico"
	}, {
		"id": "44",
		"name": "Rhode Island"
	}, {
		"id": "45",
		"name": "South Carolina"
	}, {
		"id": "46",
		"name": "South Dakota"
	}, {
		"id": "47",
		"name": "Tennessee"
	}, {
		"id": "48",
		"name": "Texas"
	}, {
		"id": "78",
		"name": "United States Virgin Islands"
	}, {
		"id": "49",
		"name": "Utah"
	}, {
		"id": "50",
		"name": "Vermont"
	}, {
		"id": "51",
		"name": "Virginia"
	}, {
		"id": "53",
		"name": "Washington"
	}, {
		"id": "54",
		"name": "West Virginia"
	}, {
		"id": "55",
		"name": "Wisconsin"
	}, {
		"id": "56",
		"name": "Wyoming"
	}],
	"links": [{
		"source": "01",
		"target": "02"
	}, {
		"source": "01",
		"target": "60"
	}, {
		"source": "01",
		"target": "04"
	}, {
		"source": "01",
		"target": "05"
	}, {
		"source": "02",
		"target": "60"
	}, {
		"source": "02",
		"target": "04"
	}, {
		"source": "02",
		"target": "05"
	}, {
		"source": "60",
		"target": "04"
	}, {
		"source": "60",
		"target": "05"
	}, {
		"source": "04",
		"target": "05"
	}, {
		"source": "06",
		"target": "08"
	}, {
		"source": "06",
		"target": "69"
	}, {
		"source": "06",
		"target": "09"
	}, {
		"source": "08",
		"target": "69"
	}, {
		"source": "08",
		"target": "09"
	}, {
		"source": "69",
		"target": "09"
	}, {
		"source": "10",
		"target": "11"
	}, {
		"source": "13",
		"target": "66"
	}, {
		"source": "16",
		"target": "17"
	}, {
		"source": "16",
		"target": "18"
	}, {
		"source": "16",
		"target": "19"
	}, {
		"source": "17",
		"target": "18"
	}, {
		"source": "17",
		"target": "19"
	}, {
		"source": "18",
		"target": "19"
	}, {
		"source": "20",
		"target": "21"
	}, {
		"source": "23",
		"target": "24"
	}, {
		"source": "23",
		"target": "25"
	}, {
		"source": "23",
		"target": "26"
	}, {
		"source": "23",
		"target": "27"
	}, {
		"source": "23",
		"target": "28"
	}, {
		"source": "23",
		"target": "29"
	}, {
		"source": "23",
		"target": "30"
	}, {
		"source": "24",
		"target": "25"
	}, {
		"source": "24",
		"target": "26"
	}, {
		"source": "24",
		"target": "27"
	}, {
		"source": "24",
		"target": "28"
	}, {
		"source": "24",
		"target": "29"
	}, {
		"source": "24",
		"target": "30"
	}, {
		"source": "25",
		"target": "26"
	}, {
		"source": "25",
		"target": "27"
	}, {
		"source": "25",
		"target": "28"
	}, {
		"source": "25",
		"target": "29"
	}, {
		"source": "25",
		"target": "30"
	}, {
		"source": "26",
		"target": "27"
	}, {
		"source": "26",
		"target": "28"
	}, {
		"source": "26",
		"target": "29"
	}, {
		"source": "26",
		"target": "30"
	}, {
		"source": "27",
		"target": "28"
	}, {
		"source": "27",
		"target": "29"
	}, {
		"source": "27",
		"target": "30"
	}, {
		"source": "28",
		"target": "29"
	}, {
		"source": "28",
		"target": "30"
	}, {
		"source": "29",
		"target": "30"
	}, {
		"source": "31",
		"target": "32"
	}, {
		"source": "31",
		"target": "33"
	}, {
		"source": "31",
		"target": "34"
	}, {
		"source": "31",
		"target": "35"
	}, {
		"source": "31",
		"target": "36"
	}, {
		"source": "31",
		"target": "37"
	}, {
		"source": "31",
		"target": "38"
	}, {
		"source": "32",
		"target": "33"
	}, {
		"source": "32",
		"target": "34"
	}, {
		"source": "32",
		"target": "35"
	}, {
		"source": "32",
		"target": "36"
	}, {
		"source": "32",
		"target": "37"
	}, {
		"source": "32",
		"target": "38"
	}, {
		"source": "33",
		"target": "34"
	}, {
		"source": "33",
		"target": "35"
	}, {
		"source": "33",
		"target": "36"
	}, {
		"source": "33",
		"target": "37"
	}, {
		"source": "33",
		"target": "38"
	}, {
		"source": "34",
		"target": "35"
	}, {
		"source": "34",
		"target": "36"
	}, {
		"source": "34",
		"target": "37"
	}, {
		"source": "34",
		"target": "38"
	}, {
		"source": "35",
		"target": "36"
	}, {
		"source": "35",
		"target": "37"
	}, {
		"source": "35",
		"target": "38"
	}, {
		"source": "36",
		"target": "37"
	}, {
		"source": "36",
		"target": "38"
	}, {
		"source": "37",
		"target": "38"
	}, {
		"source": "39",
		"target": "40"
	}, {
		"source": "39",
		"target": "41"
	}, {
		"source": "40",
		"target": "41"
	}, {
		"source": "42",
		"target": "72"
	}, {
		"source": "45",
		"target": "46"
	}, {
		"source": "47",
		"target": "48"
	}, {
		"source": "78",
		"target": "49"
	}, {
		"source": "50",
		"target": "51"
	}, {
		"source": "53",
		"target": "54"
	}, {
		"source": "53",
		"target": "55"
	}, {
		"source": "53",
		"target": "56"
	}, {
		"source": "54",
		"target": "55"
	}, {
		"source": "54",
		"target": "56"
	}, {
		"source": "55",
		"target": "56"
	}]
}
        // List of node names
        var allNodes = data.nodes.map(function(d){return d.name})

        // A linear scale to position the nodes on the X axis
        var x = d3.scalePoint()
            .range([0, width])
            .domain(allNodes)

        // Add the circle for the nodes
        var nodes = svg
            .selectAll("mynodes")
            .data(data.nodes)
            .enter()
            .append("circle")
            .attr("cx", function(d){ return(x(d.name))})
            .attr("cy", height-30)
            .attr("r", 8)
            .style("fill", "#69b3a2")

        // And give them a label
        var labels = svg
            .selectAll("mylabels")
            .data(data.nodes)
            .enter()
            .append("text")
            .attr("x", function(d){ return(x(d.name))})
            .attr("y", height-10)
            .text(function(d){ return(d.name)})
            .style("text-anchor", "start")
            .attr("transform", "rotate(90)")
            .attr("transform-origin", d => `${x(d.name)}px ${height-10 -6}px`)

        // Add links between nodes. Here is the tricky part.
        // In my input data, links are provided between nodes -id-, NOT between node names.
        // So I have to do a link between this id and the name
        var idToNode = {};
        data.nodes.forEach(function (n) {
            idToNode[n.id] = n;
        });
        // Cool, now if I do idToNode["2"].name I've got the name of the node with id 2
        let stateIdsToBeHighlighted = []
        // Add the links
        var links = svg
            .selectAll('mylinks')
            .data(data.links)
            .enter()
            .append('path')
            .attr('d', function (d) {
            start = x(idToNode[d.source].name)    // X position of start node on the X axis
            end = x(idToNode[d.target].name)      // X position of end node
            return ['M', start, height-30,    // the arc starts at the coordinate x=start, y=height-30 (where the starting node is)
                'A',                            // This means we're gonna build an elliptical arc
                (start - end)/2, ',',    // Next 2 lines are the coordinates of the inflexion point. Height of this point is proportional with start - end distance
                (start - end)/2, 0, 0, ',',
                start < end ? 1 : 0, end, ',', height-30] // We always want the arc on top. So if end is before start, putting 0 here turn the arc upside down.
                .join(' ');
            })
            .style("fill", "none")
            .attr("stroke", "black")

            // Add the highlighting functionality
            nodes
            .on('mouseover', function (d) {
                console.log(d)
                // Highlight the nodes: every node is green except of him
                nodes.style('fill', "#B8B8B8")
                d3.select(this).style('fill', '#69b3b2')
                // Highlight on the map
                    // find all the target and sources from links that start with the same name
                    data.nodes.forEach(n => {
                        if(n.name.startsWith(d.name[0].toString())) {
                            stateIdsToBeHighlighted.push(n.id)
                        }
                    })
                    stateIdsToBeHighlighted.forEach((stateId, index) => {
                        d3.select(`#state-${stateId}`).style('fill', '#85d585')
                    })
                // Highlight the connections
                links
                .style('stroke', function (link_d) { return link_d.source === d.id || link_d.target === d.id ? '#69b3b2' : '#b8b8b8';})
                .style('stroke-width', function (link_d) { return link_d.source === d.id || link_d.target === d.id ? 4 : 1;})
            })
            .on('mouseout', function (d) {
                nodes.style('fill', "#69b3a2")
                links
                .style('stroke', 'black')
                .style('stroke-width', '1')
                // Un - Highlight on the map
                stateIdsToBeHighlighted.forEach((stateId, index) => {
                    d3.select(`#state-${stateId}`).style('fill', 'lightgrey')
                })
                stateIdsToBeHighlighted = []
            })
        })

        // text hover nodes
        // svg
        // .append("text")
        //     .attr("text-anchor", "middle")
        //     .style("fill", "#B8B8B8")
        //     .style("font-size", "17px")
        //     .attr("x", 50)
        //     .attr("y", 10)
        //     .html("Hover nodes")

    </script>
    <script>
        const svgMap = d3.select("#map");
        const path = d3.geoPath();

        d3.json("https://d3js.org/us-10m.v1.json", function (error, us) {
            if (error) throw error;
            console.log(us)
            svgMap.append("g")
                .attr("class", "states")
                .selectAll("path")
                .data(topojson.feature(us, us.objects.states).features)
                .enter().append("path")
                .attr("d", path)
                .attr("fill", "lightgrey")
                .attr("id", d => `state-${d.id}`)
                .on('mouseover', function (d) {
                    console.log(d)
                })

            svgMap.append("path")
                .attr("class", "state-borders")
                .attr("d", path(topojson.mesh(us, us.objects.states, function (a, b) { return a !== b; })));
        });
    </script>
    <!-- <script type="module" src="./index.js"></script> -->
    <script type="module" src="./try.js"></script>
</body>
</html>
<!-- 
    Approach 

    1. After matching the old state data to the new one we realize the state ids are the same.
    2. form your arc data (minimum in the beginning)
    3. Test your North Dakota logic
    4. Highlight arcs and manipulate using classes and ids and match with the state id
 -->